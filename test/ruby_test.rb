# coding: utf-8
require 'test_helper'

class TupleRubyTest < Minitest::Test
  module Ruby
    extend Tuple::Ruby
  end

  {
    nil => "\x00\x00\x00\x00",
    false => "\x00\x00\x01\x00",
    true => "\x00\x00\xFF\x00",
    0 => "\x00\x00\x10\x01\x00\x00\x00\x00",
    1 => "\x00\x00\x10\x01\x00\x00\x00\x01",
    -1 => "\x00\x00\b\xFE\xFF\xFF\xFF\xFE",
    2**38 => "\x00\x00\x10\x02\x00\x00\x00@\x00\x00\x00\x00",
    -2**38 => "\x00\x00\b\xFD\xFF\xFF\xFF\xBF\xFF\xFF\xFF\xFF",
    2**64 => "\x00\x00\x10\x03\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00",
    -2**64 => "\x00\x00\b\xFC\xFF\xFF\xFF\xFE\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF",
    Date.parse('2017-01-18') => "\x00\x00\x80\x002017-01-18\x00\x00",
    Time.parse('2015-12-12 08:17:23 +0000') => "\x00\x00\x80\x002015-12-12 08:17:23 +0000\x00\x00\x00",
    '' => "\x00\x00 \x00",
    'hello' => "\x00\x00 \x00hello\x00\x00\x00",
    ''.to_sym => "\x00\x00@\x00",
    'hellÃ¶'.force_encoding('binary').to_sym => "\x00\x00@\x00hell\xC3\xB6\x00\x00",
    [] => "\x00\x00\xC0\x00\x00\x00\xBF\x00",
    [nil] => "\x00\x00\xC0\x00\x00\x00\x00\x00\x00\x00\xBF\x00",
    [1, true, :foo, "foo", -1001, false, nil, [:foo, 1, 4, nil]] => "\x00\x00\xC0\x00\x00\x00\x10\x01\x00\x00\x00\x01\x00\x00\xFF\x00\x00\x00@\x00foo\x00\x00\x00 \x00foo\x00\x00\x00\b\xFE\xFF\xFF\xFC\x16\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\xC0\x00\x00\x00@\x00foo\x00\x00\x00\x10\x01\x00\x00\x00\x01\x00\x00\x10\x01\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\xBF\x00\x00\x00\xBF\x00",
  }.each do |element,expected_dump|

    should "load and dump #{element.inspect}" do
      expected_dump_binary = expected_dump.force_encoding('binary')
      assert_equal(expected_dump_binary,Ruby.dump([element]))
      assert_equal(expected_dump_binary,Ruby.dump(element)) unless element.is_a?(Array)
      assert_equal([element],Ruby.load(expected_dump_binary))
    end
  end

  should "raise type error for unsupported elements" do
    exception = assert_raises(TypeError) do
      Ruby.dump(1.0)
    end
    assert_equal("invalid type Float in tuple",exception.message)
  end
end
